<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aka-browser</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: transparent;
        color: #ffffff;
        overflow: hidden;
        margin: 0;
        padding: 0;
      }

      .app-container {
        width: 100vw;
        height: 100vh;
        border-radius: 12px;
        overflow: hidden;
      }

      .top-bar {
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        margin: 8px 8px 12px 8px;
        background: rgba(40, 40, 40, 0.95);
        backdrop-filter: blur(40px) saturate(180%);
        border-radius: 12px;
        -webkit-app-region: drag;
      }

      .window-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        -webkit-app-region: no-drag;
      }

      .window-btn {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .window-btn.close {
        background: #ff5f57;
      }

      .window-btn.minimize {
        background: #ffbd2e;
      }

      .window-btn:hover::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 6px;
        height: 1px;
        background: rgba(0, 0, 0, 0.6);
      }

      .window-btn.close:hover::before {
        width: 6px;
        height: 6px;
        background: transparent;
        border: none;
      }

      .window-btn.close:hover::after {
        content: "×";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 10px;
        color: rgba(0, 0, 0, 0.7);
        font-weight: bold;
      }

      .app-title {
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.3px;
        color: rgba(255, 255, 255, 0.85);
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .device-name {
        font-size: 13px;
        font-weight: 600;
      }

      .device-info {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 400;
      }

      .controls {
        display: flex;
        gap: 10px;
        -webkit-app-region: no-drag;
      }

      .control-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
      }

      .control-btn:active {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(0.95);
      }

      /* Outermost border layer: #11111D 1px */
      .frame-layer-1 {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 47px;
        background: #11111d;
        box-sizing: border-box;
        pointer-events: none;
        padding: 1px;
      }

      /* Second border layer: #54545B 1px */
      .frame-layer-2 {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 46px;
        background: #54545b;
        box-sizing: border-box;
        pointer-events: none;
        padding: 1px;
      }

      /* Third border layer: #525252 1px */
      .frame-layer-2::before {
        content: "";
        position: absolute;
        top: 1px;
        left: 1px;
        right: 1px;
        bottom: 1px;
        border-radius: 45px;
        background: #525252;
        pointer-events: none;
        z-index: 0;
      }

      /* Fourth border layer: #2B2C2C 5px */
      .frame-layer-2::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        border-radius: 44px;
        background: #2b2c2c;
        pointer-events: none;
        z-index: 0;
      }

      .phone-frame {
        position: absolute;
        top: 7px;
        left: 7px;
        right: 7px;
        bottom: 7px;
        border-radius: 40px;
        background: transparent;
        pointer-events: none;
        box-sizing: border-box;
        border: 8px solid #000100;
        z-index: 5;
      }

      .dynamic-island {
        position: absolute;
        top: 11.5px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 35px;
        background: #000000;
        border-radius: 20px;
        z-index: 20;
        pointer-events: none;
      }

      .status-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 58px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 15px;
        color: var(--text-color, #ffffff);
        z-index: 15;
        background: transparent;
        border-radius: 32px 32px 0 0;
        overflow: hidden;
        pointer-events: none;
      }

      .time {
        font-weight: 590;
        position: absolute;
        left: 0;
        right: 0;
        text-align: left;
        padding-left: calc((50% - 60px) / 2 - 10px);
        font-size: 15px;
        letter-spacing: -0.3px;
      }

      .phone-container {
        position: absolute;
        top: 72px;
        left: 8px;
        width: calc(100% - 16px);
        height: calc(100% - 80px);
        z-index: 10;
        overflow: hidden;
        border-radius: 40px;
      }

      .webview-wrapper {
        position: absolute;
        top: 15px;
        left: 15px;
        right: 15px;
        bottom: 15px;
        border-radius: 32px;
        overflow: hidden;
        z-index: 10;
        background: transparent;
        pointer-events: auto;
      }

      .webview-mask {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 58px;
        background: var(--theme-color, #000000);
        z-index: 2;
        pointer-events: none;
        border-radius: 32px 32px 0 0;
        overflow: hidden;
      }

      .webview-content {
        position: absolute;
        top: 58px;
        left: 0;
        width: 100%;
        height: calc(100% - 58px);
        border-radius: 0 0 32px 32px;
        overflow: hidden;
      }

      webview {
        width: 100%;
        height: 100%;
        background: transparent;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="top-bar">
        <div class="window-controls">
          <button class="window-btn close" id="close-btn"></button>
          <button class="window-btn minimize" id="minimize-btn"></button>
        </div>
        <div class="app-title">
          <div class="device-name">iPhone 15 Pro</div>
          <div class="device-info">iOS 28.0</div>
        </div>
        <div class="controls">
          <button class="control-btn" id="back-btn" title="Back">←</button>
          <button class="control-btn" id="forward-btn" title="Forward">
            →
          </button>
          <button class="control-btn" id="refresh-btn" title="Refresh">
            ↻
          </button>
        </div>
      </div>

      <div class="phone-container">
        <div class="frame-layer-1">
          <div class="frame-layer-2">
            <div class="webview-wrapper">
              <div class="webview-content">
                <webview
                  id="webview"
                  src="https://www.google.com"
                  partition="persist:main"
                ></webview>
              </div>
              <div class="webview-mask"></div>
              <div class="dynamic-island"></div>
              <div class="status-bar">
                <div class="time" id="time">9:41</div>
              </div>
            </div>
            <div class="phone-frame"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Update time
      function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, "0");
        const minutes = now.getMinutes().toString().padStart(2, "0");
        document.getElementById("time").textContent = `${hours}:${minutes}`;
      }
      updateTime();
      setInterval(updateTime, 60000);

      // Navigation controls
      const webview = document.getElementById("webview");
      const backBtn = document.getElementById("back-btn");
      const forwardBtn = document.getElementById("forward-btn");
      const refreshBtn = document.getElementById("refresh-btn");

      console.log("Webview element:", webview);

      webview.addEventListener("did-start-loading", () => {
        console.log("Webview started loading");
      });

      webview.addEventListener("did-stop-loading", () => {
        console.log("Webview stopped loading");
      });

      webview.addEventListener("dom-ready", () => {
        console.log("Webview DOM ready");
      });

      webview.addEventListener("did-fail-load", (event) => {
        console.error("Webview failed to load:", event);
      });

      backBtn.addEventListener("click", () => {
        if (webview.canGoBack()) {
          webview.goBack();
        }
      });

      forwardBtn.addEventListener("click", () => {
        if (webview.canGoForward()) {
          webview.goForward();
        }
      });

      refreshBtn.addEventListener("click", () => {
        webview.reload();
      });

      // Window controls
      const closeBtn = document.getElementById("close-btn");
      const minimizeBtn = document.getElementById("minimize-btn");

      closeBtn.addEventListener("click", () => {
        if (window.electronAPI) {
          window.electronAPI.closeWindow();
        }
      });

      minimizeBtn.addEventListener("click", () => {
        if (window.electronAPI) {
          window.electronAPI.minimizeWindow();
        }
      });

      // Calculate luminance to determine if color is light or dark
      function getLuminance(color) {
        // Parse RGB values from various color formats
        let r, g, b;

        if (color.startsWith("#")) {
          const hex = color.replace("#", "");
          r = parseInt(hex.substr(0, 2), 16);
          g = parseInt(hex.substr(2, 2), 16);
          b = parseInt(hex.substr(4, 2), 16);
        } else if (color.startsWith("rgb")) {
          const matches = color.match(/\d+/g);
          if (matches) {
            r = parseInt(matches[0]);
            g = parseInt(matches[1]);
            b = parseInt(matches[2]);
          }
        }

        if (r !== undefined && g !== undefined && b !== undefined) {
          // Calculate relative luminance
          const rsRGB = r / 255;
          const gsRGB = g / 255;
          const bsRGB = b / 255;

          const rLinear =
            rsRGB <= 0.03928
              ? rsRGB / 12.92
              : Math.pow((rsRGB + 0.055) / 1.055, 2.4);
          const gLinear =
            gsRGB <= 0.03928
              ? gsRGB / 12.92
              : Math.pow((gsRGB + 0.055) / 1.055, 2.4);
          const bLinear =
            bsRGB <= 0.03928
              ? bsRGB / 12.92
              : Math.pow((bsRGB + 0.055) / 1.055, 2.4);

          return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear;
        }

        return 0; // Default to dark
      }

      // Theme color detection and application
      function updateThemeColor() {
        try {
          webview
            .executeJavaScript(
              `
          (function() {
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (metaThemeColor) {
              return metaThemeColor.getAttribute('content');
            }
            
            // Fallback: try to get background color from body
            const bodyBg = window.getComputedStyle(document.body).backgroundColor;
            return bodyBg;
          })();
        `
            )
            .then((themeColor) => {
              if (
                themeColor &&
                themeColor !== "rgba(0, 0, 0, 0)" &&
                themeColor !== "transparent"
              ) {
                document.documentElement.style.setProperty(
                  "--theme-color",
                  themeColor
                );

                // Calculate appropriate text color based on background luminance
                const luminance = getLuminance(themeColor);
                const textColor = luminance > 0.5 ? "#000000" : "#ffffff";
                document.documentElement.style.setProperty(
                  "--text-color",
                  textColor
                );

                console.log(
                  "Theme color updated:",
                  themeColor,
                  "Text color:",
                  textColor
                );
              } else {
                document.documentElement.style.setProperty(
                  "--theme-color",
                  "#000000"
                );
                document.documentElement.style.setProperty(
                  "--text-color",
                  "#ffffff"
                );
              }
            })
            .catch((err) => {
              console.error("Failed to get theme color:", err);
            });
        } catch (err) {
          console.error("Error updating theme color:", err);
        }
      }

      // Update theme color when page loads
      webview.addEventListener("dom-ready", () => {
        console.log("Webview DOM ready");
        updateThemeColor();
        // Poll for changes in case meta tag is added dynamically
        setTimeout(updateThemeColor, 100);
        setTimeout(updateThemeColor, 300);
        setTimeout(updateThemeColor, 600);
      });

      webview.addEventListener("did-navigate", () => {
        updateThemeColor();
        setTimeout(updateThemeColor, 100);
        setTimeout(updateThemeColor, 300);
      });

      webview.addEventListener("did-navigate-in-page", () => {
        updateThemeColor();
        setTimeout(updateThemeColor, 100);
      });

      webview.addEventListener("did-start-loading", () => {
        // Reset to default while loading
        document.documentElement.style.setProperty("--theme-color", "#000000");
        document.documentElement.style.setProperty("--text-color", "#ffffff");
      });

      webview.addEventListener("did-stop-loading", () => {
        updateThemeColor();
        setTimeout(updateThemeColor, 100);
        setTimeout(updateThemeColor, 300);
      });
    </script>
  </body>
</html>
