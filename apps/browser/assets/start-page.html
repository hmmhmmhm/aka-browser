<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>New Tab</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue",
          Arial, sans-serif;
        background: #1c1c1e;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: #ffffff;
      }

      .bookmarks-container {
        width: 100%;
        max-width: 800px;
        margin-top: 120px;
      }

      .bookmarks-title {
        font-size: 20px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 24px;
        text-align: center;
      }

      .bookmarks-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        padding: 0 20px;
        max-width: 100%;
      }

      .bookmark-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        padding: 16px 12px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.05);
        transition: all 0.2s ease;
        cursor: pointer;
        min-width: 0;
      }

      .bookmark-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      .bookmark-icon {
        width: 64px;
        height: 64px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin-bottom: 12px;
        overflow: hidden;
        background: transparent;
      }

      .bookmark-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .bookmark-title {
        font-size: 13px;
        font-weight: 500;
        color: #ffffff;
        text-align: center;
        word-break: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .bookmark-url {
        font-size: 11px;
        color: #8e8e93;
        text-align: center;
        margin-top: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #8e8e93;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 15px;
        line-height: 1.6;
        text-wrap: balance;
        word-break: keep-all;
      }

      @media (max-width: 600px) {
        .bookmarks-grid {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 16px;
        }

        .bookmark-icon {
          width: 56px;
          height: 56px;
          font-size: 28px;
        }
      }
    </style>
  </head>
  <body>
    <div class="bookmarks-container">
      <h2 class="bookmarks-title">Favorites</h2>
      <div class="bookmarks-grid" id="bookmarksGrid">
        <!-- Bookmarks will be inserted here -->
      </div>
      <div class="empty-state" id="emptyState" style="display: none">
        <div class="empty-state-icon">‚≠ê</div>
        <div class="empty-state-text">
          No favorites yet.<br />
          Click the menu button to add your favorite sites.
        </div>
      </div>
    </div>

    <script>
      // Get high-resolution favicon URL
      function getHighResFavicon(url) {
        try {
          const domain = new URL(url).origin;
          // Try multiple high-res favicon sources
          return [
            `${domain}/apple-touch-icon.png`, // 180x180 or higher
            `${domain}/apple-touch-icon-precomposed.png`,
            `https://www.google.com/s2/favicons?domain=${domain}&sz=128`, // Google's high-res favicon service
            `${domain}/favicon.ico`,
          ];
        } catch {
          return [];
        }
      }

      // Default bookmarks
      const defaultBookmarks = [
        {
          id: "default-google",
          title: "Google",
          url: "https://www.google.com",
          favicon: "https://www.google.com/s2/favicons?domain=google.com&sz=128",
          displayUrl: "google.com",
        },
        {
          id: "default-youtube",
          title: "YouTube",
          url: "https://www.youtube.com",
          favicon: "https://www.google.com/s2/favicons?domain=youtube.com&sz=128",
          displayUrl: "youtube.com",
        },
        {
          id: "default-netflix",
          title: "Netflix",
          url: "https://www.netflix.com",
          favicon: "https://www.google.com/s2/favicons?domain=netflix.com&sz=128",
          displayUrl: "netflix.com",
        },
        {
          id: "default-x",
          title: "X",
          url: "https://x.com",
          favicon: "https://www.google.com/s2/favicons?domain=x.com&sz=128",
          displayUrl: "x.com",
        },
      ];

      // Load bookmarks from storage
      async function loadBookmarks() {
        try {
          const bookmarks = await window.electronAPI?.bookmarks?.getAll();
          const grid = document.getElementById("bookmarksGrid");
          const emptyState = document.getElementById("emptyState");

          // Load hidden default bookmarks from localStorage
          let hiddenDefaults = [];
          try {
            const hidden = localStorage.getItem("hiddenDefaultBookmarks");
            if (hidden) {
              hiddenDefaults = JSON.parse(hidden);
            }
          } catch (error) {
            console.error("Failed to load hidden bookmarks:", error);
          }

          // Filter out hidden default bookmarks
          const visibleDefaults = defaultBookmarks.filter(
            (bookmark) => !hiddenDefaults.includes(bookmark.id)
          );

          // Combine user bookmarks and visible default bookmarks
          const userBookmarks = bookmarks || [];
          const displayBookmarks = [...userBookmarks, ...visibleDefaults];

          console.log("[Start Page] User bookmarks:", userBookmarks.length, userBookmarks);
          console.log("[Start Page] Visible defaults:", visibleDefaults.length, visibleDefaults);
          console.log("[Start Page] Total display bookmarks:", displayBookmarks.length, displayBookmarks);

          if (displayBookmarks.length === 0) {
            grid.style.display = "none";
            emptyState.style.display = "block";
            return;
          }

          grid.style.display = "grid";
          emptyState.style.display = "none";
          grid.innerHTML = "";

          displayBookmarks.forEach((bookmark) => {
            const item = document.createElement("a");
            item.className = "bookmark-item";
            item.href = bookmark.url;
            item.onclick = (e) => {
              e.preventDefault();
              window.location.href = bookmark.url;
            };

            const icon = document.createElement("div");
            icon.className = "bookmark-icon";

            if (bookmark.favicon) {
              const img = document.createElement("img");
              
              // Try high-res favicon first, fallback to provided favicon
              const faviconSources = bookmark.id && bookmark.id.startsWith('default-') 
                ? [bookmark.favicon] // Use direct URL for default bookmarks
                : getHighResFavicon(bookmark.url).concat([bookmark.favicon]);
              
              let currentIndex = 0;
              
              const tryNextFavicon = () => {
                if (currentIndex < faviconSources.length) {
                  img.src = faviconSources[currentIndex];
                  currentIndex++;
                } else {
                  // All sources failed, show first letter
                  icon.removeChild(img);
                  icon.textContent = bookmark.title.charAt(0).toUpperCase();
                }
              };
              
              img.onerror = tryNextFavicon;
              tryNextFavicon(); // Start loading first source
              
              icon.appendChild(img);
            } else {
              // Try to get high-res favicon even if not provided
              const img = document.createElement("img");
              const faviconSources = getHighResFavicon(bookmark.url);
              let currentIndex = 0;
              
              const tryNextFavicon = () => {
                if (currentIndex < faviconSources.length) {
                  img.src = faviconSources[currentIndex];
                  currentIndex++;
                } else {
                  // All sources failed, show first letter
                  icon.removeChild(img);
                  icon.textContent = bookmark.title.charAt(0).toUpperCase();
                }
              };
              
              img.onerror = tryNextFavicon;
              tryNextFavicon();
              
              icon.appendChild(img);
            }

            const title = document.createElement("div");
            title.className = "bookmark-title";
            title.textContent = bookmark.title;

            const url = document.createElement("div");
            url.className = "bookmark-url";
            if (bookmark.displayUrl) {
              url.textContent = bookmark.displayUrl;
            } else {
              try {
                const hostname = new URL(bookmark.url).hostname;
                // Remove www. prefix
                url.textContent = hostname.replace(/^www\./, '');
              } catch {
                url.textContent = bookmark.url;
              }
            }

            item.appendChild(icon);
            item.appendChild(title);
            item.appendChild(url);
            grid.appendChild(item);
          });
        } catch (error) {
          console.error("Failed to load bookmarks:", error);
        }
      }

      // Listen for bookmark updates
      if (window.electronAPI?.bookmarks?.onUpdate) {
        window.electronAPI.bookmarks.onUpdate(() => {
          loadBookmarks();
        });
      }

      // Load bookmarks on page load
      loadBookmarks();
    </script>
  </body>
</html>
